#!/usr/bin/env bash
# vim: fdm=marker

set -eu

prgname=${0##*/}

sessions=(

    # Arch (01/2020) {{{
    # ----------------------------------------
    #
    # awesome
    # blackbox
    # bspwm
    # ctwm
    # enlightenment
    # fluxbox
    # fvwm
    # gala
    # herbstluftwm
    # i3            # (i3-gaps, i3-wm)
    # icewm
    # jwm
    # kwin_x11      # (kwin) KDE Plasma
    # lwm
    # marco         # fork of Metacity
    # metacity      # GNOME 2.x / GNOME Flashback; using GTK 3.x since 3.12.0
    # muffin        # Cinnamon; fork of Mutter
    # mutter        # GNOME 3.x; using Clutter toolkit
    # notion
    # openbox
    # pekwm
    # qtile
    # ratpoison
    # rio           # (plan9)
    # spectrwm      # formerly scrotwm
    # twm           # (xorg-twm)
    # ukwm
    # xfwm4
    # xmonad
    #
    # }}}

    # AUR (01/2020) {{{
    # ----------------------------------------
    #
    # 2bwm
    # 9wm
    # adwm
    # aewm++
    # afterstep
    # alopex
    # antares
    # antiwm
    # berry
    # bubbles
    # chamfer
    # cwm
    # dwin
    # dwm
    # echinus
    # etwm
    # evilwm
    # failsafewm
    # flatman
    # flwm
    # foo-wm
    # frankenwm
    # glass-wm
    # goomwwm
    # heliwm
    # howm
    # jbwm
    # karmen
    # katriawm
    # larswm
    # lcarswm
    # leftwm
    # mantis-wm
    # matchbox
    # matwm2
    # mcwm
    # mlvwm
    # mmwm
    # moksha
    # nimdow
    # olvwm
    # pawm
    # qvwm
    # sawfish
    # sowm
    # stumpwm
    # subtle
    # tinywm
    # tritium
    # twobwm
    # ude
    # unagi
    # uwm
    # velox
    # vtwm
    # waimea
    # windowchef
    # windowlab
    # windowmaker
    # windwm
    # wingo
    # wm2
    # wmderland
    # wmfs
    # wmii
    # wmx
    # wtftw
    # wumwum
    # xdwm
    # xwm
    # yeahwm
    #
    # }}}

    # Other {{{
    # ----------------------------------------
    #
    # aewm
    # catwm
    # dminiwm
    # ion3
    # monsterwm
    # possum-wm
    # smallwm
    # swm
    #
    # }}}

    # ----------------------------------------

    ctwm
    i3
    jwm
    kodi
    main
    openbox
    rio
    xfwm4
    xmonad
)

if (( ! $# )); then
    printf '%s\n' "${sessions[@]}"
    exit
fi

if [[ $prgname = xsession ]]; then
    exec srun -X -n xsession xsession-bin "$@"
fi

screen=$(xserverq screen)
sfile=$XDG_RUNTIME_DIR/xorg/xsession:$screen
exec 8>"$sfile".lock
flock -n 8 || exit 3

exec &>~/.local/share/xorg/xsession:"$screen".out
echo $'\n--------------------------------------------------'
printf '> xsession: %s\n\n' "$*" >&2

session=unknown
for i in "${sessions[@]}"; do
    [[ $1 = "$i" ]] && { session=$i; break; }
done
printf '%s\n' "$session" >"$sfile"
printf 'session: %s\n' "$session" >&2

cleanup() {
    local retstat=$?
    printf '\n> xsession: exit %s\n' "$retstat" >&2
    set +e
    xsession-hook post
    # shellcheck disable=SC2046
    kill $(jobs -p) &>/dev/null
}
trap cleanup EXIT

xscreen -
xsession-hook pre
xsession-hook exec "$@"
