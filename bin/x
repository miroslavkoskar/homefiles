#!/bin/bash
#
# X session startup script.
#
# If no arguments are passed, simple menu of predefined X sessions
# is presented to choose from. Otherwise arguments define what to do.
#
# By default:
#
# * allocates VT passed in XDG_VTNR (which by default corresponds to active VT)
# * dislay number will be the same as VT number
# * continue only if display number is not used already
# * startx ~/bin/xsession "$@" -- /usr/bin/X
#
# If started as 'xx':
#
# * dislay number will be the first free starting with 91
# * startx ~/bin/xsession "$@" -- /usr/bin/Xephyr
#
# :Copyright: (c) 2013 Miroslav Koskar (http://mkoskar.com/)
# :License: BSD 2-Clause

set -e

ti_reset=$'\e[m'
ti_hi0=$'\e[1;37m'
ti_hi1=$'\e[1;32m'

if [ $# -eq 0 ]; then
    echo
    echo "${ti_hi0}m) main ${ti_hi1}[default]${ti_reset}"
    echo 'h) herbstluftwm'
    echo 'o) openbox'
    echo 'x) xmonad'

    read -N1 -s -p ': ' sel
    test ! "$sel" && sel=m
    case $sel in
        [mM])
            set -- main
            ;;
        [hH])
            set -- herbstluftwm
            ;;
        [oO])
            set -- openbox
            ;;
        [xX])
            set -- xmonad
            ;;
        *)
            echo -e '---\n'
            exit 1
            ;;
    esac
    echo -e "$sel\n"
fi

# -------- /usr/bin/Xephyr

if [ "$(basename "$0")" = 'xx' ]; then
    dispno=91
    while true; do
        [ ! -e "/tmp/.X$dispno-lock" ] && break
        dispno=$((dispno+1))
    done

    startx ~/bin/xsession "$@" -- \
        /usr/bin/Xephyr ":$dispno" -nolisten tcp -dpi 96 -resizeable \
        &>"$HOME/.xsession$dispno.out" &
    exit
fi

# -------- /usr/bin/X

vtno=$XDG_VTNR # vtno=$(fgconsole)
dispno=$vtno
lockfile="/tmp/.X$dispno-lock"

if [ -e "$lockfile" ]; then
    echo -e "Display $dispno is currently in use (pid=$(cat "$lockfile" | sed 's/\s//g')).\n"
    exit 1
fi

exec startx ~/bin/xsession "$@" -- \
    /usr/bin/X ":$dispno" "vt$vtno" -nolisten tcp -dpi 96 \
    &>"$HOME/.xsession$dispno.out"
