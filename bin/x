#!/usr/bin/env bash
#
# X session startup script.
#
# If no arguments are passed, simple menu of predefined X sessions
# is presented to choose from. Otherwise arguments define what to do.
#
# By default:
#
# * allocates VT passed in XDG_VTNR (which by default corresponds to active VT)
# * display number will be the same as VT number
# * continue only if display number is not used already
# * xinit ~/bin/xsession "$@" -- /usr/bin/X
#
# If started as 'xx':
#
# * display number will be the first free starting with 91
# * xinit ~/bin/xsession "$@" -- /usr/bin/Xephyr

set -eu

prgname=${0##*/}

if (( EUID == 0 )); then
    echo 'This script must NOT be run as root.' >&2
    exit 1
fi

ti_reset=$'\e[m'
ti_hi0=$'\e[1;37m'
ti_hi1=$'\e[1;32m'

# ----------------------------------------

if (( ! $# )); then
    echo
    echo "${ti_hi0}m) main ${ti_hi1}[default]${ti_reset}"
    echo 'o) openbox'
    echo 'x) xmonad'

    read -N1 -rsp ': ' sel
    case ${sel:=m} in
        [mM])
            set -- main
            ;;
        [oO])
            set -- openbox
            ;;
        [xX])
            set -- xmonad
            ;;
        *)
            echo -e '---\n'
            exit 1
            ;;
    esac
    echo -e "$sel\n"
fi

# ----------------------------------------

rundir="$XDG_RUNTIME_DIR/xorg"
mkdir -p "$rundir"

datadir="${XDG_DATA_HOME:-$HOME/.local/share}/xorg"
mkdir -p "$datadir"

xauthset() {
    local dispno=$1
    local cookie; cookie=$(mcookie)

    # server's X authority file (global)
    xauthf="$rundir/X$dispno-Xauthority"
    xauth -q -f "$xauthf" add ":$dispno" . "$cookie" &>/dev/null

    # user's X authority file
    xauth -q add ":$dispno" . "$cookie" &>/dev/null
}

unset SESSION_MANAGER


# /usr/bin/Xephyr
# ----------------------------------------

if [[ $prgname = 'xx' ]]; then
    for (( dispno=91; 1; dispno++ )); do
        [[ -e /tmp/.X$dispno-lock ]] || break
    done

    xauthset "$dispno"

    unset XSESSION
    xinit ~/bin/xsession "$@" -- \
        /usr/bin/Xephyr ":$dispno" \
        -nolisten tcp -auth "$xauthf" -dpi 96 -resizeable \
        &>"$datadir/xsession.$dispno.out" &
    exit
fi


# /usr/bin/X
# ----------------------------------------

vtno=$XDG_VTNR
dispno=$vtno
lockfile="/tmp/.X$dispno-lock"

if [[ -e $lockfile ]]; then
    read -ra pid <"$lockfile"
    echo -e "Display $dispno is currently in use (pid=$pid).\n"
    exit 1
fi

xauthset "$dispno"

exec xinit ~/bin/xsession "$@" -- \
    /usr/bin/X ":$dispno" "vt$vtno" \
    -config "${XCONFIG:-xorg.conf.$HOSTNAME}" \
    -keeptty -novtswitch -nolisten tcp -auth "$xauthf" \
    &>"$datadir/xsession.$dispno.out"
