#!/usr/bin/env bash

set -eu -o pipefail

set -- -udprN "$@"
cmd=(diff "$@")
prgname=${0##*/}

main() {
    case $prgname in
        d0)
            "${cmd[@]}"
            ;;
        *)
            tmpfile=$(mktemp)
            trap 'rm -f "$tmpfile"' EXIT

            declare -i retstat=
            "${cmd[@]}" >"$tmpfile" || retstat=$?

            echo '---'
            diffstat -p1 <"$tmpfile"

            echo
            filterdiff -v --remove-timestamps --annotate --strip=1 \
                       --addoldprefix=a/ --addnewprefix=b/ <"$tmpfile"

            return $retstat
            ;;
    esac
}

# execute explicitly in subshell to workaround not firing trap
( main ) | PAGER_TITLE=${cmd[@]} PAGER_EX='set ft=diff' pg0
