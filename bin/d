#!/usr/bin/env bash

set -eu -o pipefail

set -- -udprN "$@"
cmd=(diff "$@")
prgname=${0##*/}

main() {
    case $prgname in
        d0)
            "${cmd[@]}"
            ;;
        *)
            tmpfile=$(mktemp)
            cleanup() { rm -f "$tmpfile"; }
            trap cleanup EXIT

            declare -i retstat=0
            "${cmd[@]}" >"$tmpfile" || retstat=$?

            echo '---'
            diffstat -p1 <"$tmpfile"

            echo
            filterdiff -v --remove-timestamps --annotate <"$tmpfile"

            return $retstat
            ;;
    esac
}

# execute explicitly in subshell to workaround not firing trap
( main ) | PAGER_TITLE=${cmd[*]} PAGER_EX='set ft=diff' pg0
