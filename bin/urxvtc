#!/usr/bin/env bash

set -eu

export RXVT_SOCKET="$XDG_RUNTIME_DIR/urxvtd$DISPLAY"
bin='/usr/bin/urxvtc'

declare -i retstat=0
"$bin" "$@" &>/dev/null || retstat=$?
if (( retstat == 2 )); then

    (exec 8>"$RXVT_SOCKET.lock"
    if ! flock -w 30 8; then
        exit 3
    fi
    (exec 8<&-

    retstat=0
    "$bin" "$@" &>/dev/null || retstat=$?
    if (( retstat == 2 )); then
        urxvtd -q -o -f
        "$bin" "$@" &>/dev/null
    fi

    ))
fi
