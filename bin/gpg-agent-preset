#!/usr/bin/env bash

set -eu -o pipefail

preset() {
    local pass
    IFS= read -rs -p "Passphrase for (${1:0:8}...): " pass </dev/tty
    echo
    [[ $pass ]] || return 1
    pass=$(printf %s "$pass" | xxd -p)
    gpg-connect-agent <<<"PRESET_PASSPHRASE $1 -1 $pass"
}

[[ -t 0 ]] && src=~/.gnupg/gpg-agent.presets || src=/dev/stdin

while read -r keygrip; do
    preset "$keygrip"
done <"$src"
