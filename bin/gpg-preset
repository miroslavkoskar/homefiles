#!/bin/bash

set -e

_preset() {
    </dev/tty IFS= read -s -r -p "Passphrase for (${1:0:8}...): " pass;
    echo
    [ -z "$pass" ] && return 1
    <<<"PRESET_PASSPHRASE $1 -1 $(echo -n "$pass" | xxd -ps)" gpg-connect-agent
}

_clear() {
    <<<"CLEAR_PASSPHRASE --mode=normal $1" gpg-connect-agent
}

# ----------------------------------------

ids=()
[ -t 0 ] && src="$HOME/.gnupg/gpg-preset-ids" || src='/dev/stdin'
while IFS= read -r line; do
    ids+=("$line")
done <"$src"

if [ ${#ids[@]} -eq 0 ]; then
    exit 1
fi

[ "$(basename "$0")" = 'gpg-preset-clear' ] \
    && action='clear' || action='preset'

# <id> should be respective secret key fingerprint reported by:
# gpg --fingerprint --with-keygrip

for id in "${ids[@]}"; do
    _$action "$id"
done
