#!/bin/bash

set -e

_preset() {
    IFS= read -rsp "Passphrase for (${1:0:8}...): " pass </dev/tty
    echo
    [ -z "$pass" ] && return 1
    gpg-connect-agent <<<"PRESET_PASSPHRASE $1 -1 $(echo -n "$pass" | xxd -ps)"
}

_clear() {
    gpg-connect-agent <<<"CLEAR_PASSPHRASE --mode=normal $1"
}

# ----------------------------------------

[ -t 0 ] && src="$HOME/.gnupg/gpg-preset-ids" || src='/dev/stdin'
readarray -t ids <"$src"

if [ ${#ids[@]} -eq 0 ]; then
    exit 1
fi

[ "$(basename "$0")" = 'gpg-preset-clear' ] \
    && action='clear' || action='preset'

# <id> should be respective secret key fingerprint reported by:
# gpg --fingerprint --with-keygrip

for id in "${ids[@]}"; do
    _$action "$id"
done
