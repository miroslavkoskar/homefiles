#!/bin/bash

set -e

cmd=/usr/lib/gnupg/gpg-preset-passphrase

preset() {
    </dev/tty IFS= read -s -r -p "gpg-preset-passphrase (${1:0:8}...): " pass;
    echo
    [ -z "$pass" ] && return 1
    <<<"$pass" $cmd --preset "$1"
}

forget() {
    $cmd --forget "$1"
}

ids=()
[ -t 0 ] && src=~/.gnupg/gpg-preset-ids || src=0
while IFS= read -r line; do
    ids+=("$line")
done <"$src"

if [ ${#ids} -eq 0 ]; then
    exit 1
fi

[ "$(basename "$0")" = 'gpg-preset-forget' ] \
    && action='forget' || action='preset'

# <id> should be respective secret key fingerprint reported by:
# $ gpg --fingerprint --fingerprint

for id in "${ids[@]}"; do
    $action "$id"
done
