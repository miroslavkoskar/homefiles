#!/usr/bin/env bash

set -eu

prgname=${0##*/}

_usage() {
    echo "usage: $prgname ca_key pub_key identity principals [ssh-keygen opts]"
}
usage() { _usage; exit 0; }
usage_err() { _usage; exit 2; } >&2

while getopts h opt; do
    case $opt in
        h)
            usage
            ;;
        *)
            usage_err
            ;;
    esac
done
shift $((OPTIND-1))

(( $# < 4 )) && usage_err

# ----------------------------------------

ca_key=$1
pub_key=$2
identity=$3
principals=$4   # Multiple principals may be specified, separated by commas.

opts=()
if [[ $prgname = 'sshgen-hostcert' ]]; then
    identity="host_$identity"
    opts+=(-h)
else
    identity="user_$identity"
fi

opts+=(
    -s "$ca_key"
    -I "$identity"
    -n "$principals"
    -V +52w
)

if [[ $prgname = 'sshgen-cert-port-forwarding-only' ]]; then
    opts+=(
        -O no-agent-forwarding
        -O no-pty
        -O no-user-rc
        -O no-x11-forwarding
    )
fi

shift 4

ssh-keygen "${opts[@]}" "$@" "$pub_key"
