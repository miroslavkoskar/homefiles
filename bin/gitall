#!/usr/bin/env bash

set -eu -o pipefail

# shellcheck disable=SC2015
(( $# )) && set -- git "$@" || set -- :

handle() {
    set -eu
    local name=$1
    shift
    echo -e "\n> $name"
    cd "$name"
    "$@"
}
export -f handle

pargs=()
case ${2-} in
    clone | \
    f | \
    fetch | \
    pull | \
    push | \
    up | \
    update \
    )
        pargs+=(--bar)
        ;;
    *)
        pargs+=(-k)
        ;;
esac

find . -mindepth 2 -maxdepth 2 -type d -name '.git' -printf '%h\0' |
    sort -z |
    parallel -0 "${pargs[@]}" handle {} "$@"
echo
