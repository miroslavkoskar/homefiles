#!/bin/bash

set -e
shopt -s nullglob

dock=$(grep -l ata_bay /sys/devices/platform/dock.?/type)
dock=${dock%%/type}

if [ ! -d "$dock" -o ! -r "$dock/docked" ]; then
    exit 1
fi

if [ "$(basename "$0")" = 'bay-undock' ]; then
    undock=1
fi

if [ "$(basename "$0")" = 'bay-standby' ]; then
    standby=1
fi

if [ "$(<$dock/docked)" = '0' ]; then
    echo 'undocked' >&2
else
    echo 'docked' >&2
    # lspci | grep -i ata
    sysdev='/sys/devices/pci0000:00/0000:00:1f.2/ata2/host1/target1:0:0/1:0:0:0'
    devname=($sysdev/block/*)

    if [ -d "$devname" ]; then
        devname="${devname##*/}"
        dev="/dev/$devname"
    else
        echo 'no block device' >&2
    fi

    if [ -n "$standby" ]; then
        echo 'standby...' >&2
        [ ! -r "$dev" ] && exit 1

        if ! smartctl -i -n standby "$dev" &>/dev/null; then
            echo 'already in standby' >&2
        else
            hdparm -y "$dev" &>/dev/null
        fi
    fi

    if [ -n "$undock" ]; then
        if [ -r "$dev" ]; then
            echo "sync..." >&2
            sync

            echo "umountall $devname..." >&2
            umountall "$devname"
        fi

        if [ -d "$sysdev" ]; then
            echo 'detach...' >&2
            echo 1 >>"$sysdev/delete"
        fi

        echo 'undock...' >&2
        if [ ! -w "$dock/undock" ]; then
            exit 1
        fi
        echo 1 >>"$dock/undock"
    fi
fi
