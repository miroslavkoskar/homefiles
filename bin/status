#!/bin/bash

set -e

if [ "$(basename "$0")" = 'status-osd' ]; then
    out=$(status "$@")
    [ -t 1 ] && echo "$out"
    osd "$out"
    exit 0
fi

status_audio() {
    local pval=$(amixer get Master \
        | gawk 'match($0, /\[([0-9]*%)\].*\[(on|off)\]/, a) {print a[2] " " a[1]}' \
        | head -n1)
    amixer -c 0 get Headphone,1 | grep -Fq 'Playback [on]' && pval="$pval +dock"

    local rval=$(amixer get Capture \
        | gawk 'match($0, /\[([0-9]*%)\].*\[(on|off)\]/, a) {print a[2] " " a[1]}' \
        | head -n1)

    printf 'audio: %s / %s\n' "$pval" "$rval"
}

status_backlight() {
    local src='/sys/class/backlight/acpi_video0'
    local val=$(printf '%s / %s' "$(<"$src/brightness")" "$(<"$src/max_brightness")")
    printf 'backlight: %s\n' "$val"
}

status_bluetooth() {
    local val=$(bluetooth | awk -F= '{gsub(/^[ \t]+/, "", $2); print $2}')
    printf 'bluetooth: %s\n' "$val"
}

status_dpms() {
    local val='-'
    if xset q &>/dev/null; then
        xset q | grep -Fq 'DPMS is Enabled' && val='on' || val='off'
    fi
    printf 'dpms: %s\n' "$val"
}

status_wifi() {
    local val=$(wifi | awk -F= '{gsub(/^[ \t]+/, "", $2); print $2}')
    printf 'wifi: %s\n' "$val"
}

status_xkb() {
    local val='-'
    if xset q &>/dev/null; then
        val=$(setxkbmap -query | grep -F 'layout:' | awk '{print $2}')
    fi
    printf 'xkb: %s\n' "$val"
}

case $1 in
    audio)
        status_audio
        ;;
    backlight)
        status_backlight
        ;;
    bluetooth)
        status_bluetooth
        ;;
    dpms)
        status_dpms
        ;;
    wifi)
        status_wifi
        ;;
    xkb)
        status_xkb
        ;;
    *)
        status_audio
        status_backlight
        status_bluetooth
        status_dpms
        status_wifi
        status_xkb
        ;;
esac
