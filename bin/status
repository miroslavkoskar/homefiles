#!/usr/bin/env bash

set -eu -o pipefail
shopt -s nullglob

prgname=${0##*/}

if [[ $prgname = 'status-osd' ]]; then
    out=$(status "$@")
    [[ -t 1 ]] && printf '%s\n' "$out"
    osd "$out" || true
    exit 0
fi

status_audio() {
    local pval rval
    pval=$(amixer get Master \
        | gawk 'match($0, /\[([0-9]*%)\].*\[(on|off)\]/, a) {print a[2] " " a[1]}' \
        | head -n1)
    amixer -c 0 get Headphone,1 | grep -Fq 'Playback [on]' && pval="$pval +dock"
    rval=$(amixer get Capture \
        | gawk 'match($0, /\[([0-9]*%)\].*\[(on|off)\]/, a) {print a[2] " " a[1]}' \
        | head -n1)
    printf 'audio: %s / %s\n' "$pval" "$rval"
}

status_backlight() {
    local dev val
    dev='/sys/class/backlight/acpi_video0'
    printf -v val '%s / %s' "$(<"$dev/brightness")" "$(<"$dev/max_brightness")"
    printf 'backlight: %s\n' "$val"
}

status_bluetooth() {
    printf 'bluetooth: %s\n' "$(status_rfkill bluetooth)"
}

status_dpms() {
    local val='-'
    if xset q &>/dev/null; then
        xset q | grep -Fq 'DPMS is Enabled' && val='on' || val='off'
    fi
    printf 'dpms: %s\n' "$val"
}

status_rfkill() {
    local i type=$1 rfkill=()
    for i in /sys/class/rfkill/rfkill*; do
        [[ $(<"$i/type") = "$type" ]] || continue
        rfkill+=("$i")
    done
    if (( ${#rfkill[@]} )); then
        if (( $(<"$rfkill/hard") )); then
            echo 'off (hardware)'
        elif (( $(<"$rfkill/soft") )); then
            echo 'off (software)'
        else
            echo 'on'
        fi
    else
        echo 'unknown'
    fi
}

status_touchpad() {
    local val='-'
    if xset q &>/dev/null; then
        touchpad && val='on' || val='off'
    fi
    printf 'touchpad: %s\n' "$val"
}

status_trackpoint_wheel() {
    local val='-'
    if xset q &>/dev/null; then
        trackpoint-wheel && val='on' || val='off'
    fi
    printf 'trackpoint wheel: %s\n' "$val"
}

status_wifi() {
    printf 'wifi: %s\n' "$(status_rfkill wlan)"
}

status_xkb() {
    local val='-'
    if xset q &>/dev/null; then
        val=$(xkblayout-state print '%s')
    fi
    printf 'xkb: %s\n' "$val"
}

case ${1-} in
    audio | backlight | bluetooth | dpms | touchpad | trackpoint_wheel | wifi | xkb)
        status_$1
        ;;
    *)
        status_audio
        status_backlight
        status_bluetooth
        status_dpms
        status_touchpad
        status_trackpoint_wheel
        status_wifi
        status_xkb
        ;;
esac
