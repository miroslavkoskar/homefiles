#!/usr/bin/env bash
#
# Wrapper script to use Vim as a pager.

set -eu

prgname=${0##*/}

run() {
    if [[ $prgname = 'manpg' ]]; then
        export PAGER_TITLE=${MAN_PN-}
        args+=(-c 'setl ft=man')
    fi
    if [[ ${PAGER_EX-} ]]; then
        args+=(-c "$PAGER_EX")
    fi
    if [[ $prgname != 'pgx' && ${PAGER_TITLE-} ]]; then
        args+=(-c 'call NoFileSetup()')
    fi
    args+=(-- "$@")
    export PRGNAME=$prgname
    exec -a "($prgname)" "${VIMBIN:-vim}" -O -u ~/.vim/vimrc_pg "${args[@]}"
}

if [[ $prgname = 'pgx' ]]; then
    if (( ! $# )); then
        echo "usage: $prgname cmd [arg]..." >&2
        exit 2
    fi
    if [[ ! -t 1 ]]; then
        exec bashx -c "$(shell-escape "$@")"
    fi
    CMD=$(shell-escape "$@")
    export CMD
    export PAGER_TITLE=${PAGER_TITLE:-"$ $CMD"}
    args=(-c ReloadX)
    run
    exit
fi

if [[ ! -t 1 ]]; then
    exec cat -- "$@"
fi

if (( $# )) || [[ -t 0 ]]; then
    exec 0<&1
    run "$@"
    exit
fi

filter=(cat)
if [[ $prgname = 'manpg' ]]; then
    filter=(col -b)
fi

"${filter[@]}" | {
    exec 8<&0 0<&1
    export PAGER_TITLE=${PAGER_TITLE:--stdin-}
    args=(-c 'silent e /dev/fd/8')
    run
}
