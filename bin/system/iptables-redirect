#!/usr/bin/env bash

set -eu

if (( EUID )); then
    echo 'This script must be run with root privileges.' >&2
    exit 1
fi

prgname=${0##*/}

_usage() {
    cat <<-EOF
	usage: $prgname [from-addr:]from-port to-port

	Redirect connections from [from-addr:]from-port to to-port.
	Optional from-addr specified as 'local' translates to all local addresses.
	EOF
}
usage() { _usage; exit 0; }
usage_err() { _usage; exit 2; } >&2

while getopts 'h' opt; do
    case $opt in
        h)
            usage
            ;;
        *)
            usage_err
            ;;
    esac
done
shift $((OPTIND-1))

(( $# != 2 )) && usage_err

# ----------------------------------------

IFS=: read -ra from <<<"$1"
declare -i from_len=${#from[@]}

if (( from_len == 1 )); then
    from_port=${from[0]}
elif (( from_len == 2 )); then
    from_addr=${from[0]}
    from_port=${from[1]}
else
    usage_err
fi

from_addr=${from_addr:-local}
to_port=$2

if [[ $from_addr = 'local' ]]; then
    limit=(-m addrtype --dst-type LOCAL)
else
    limit=(-d "$from_addr")
fi

chain="$from_addr:$from_port->$to_port"

iptables -t nat -N "$chain"

iptables -t nat -A "$chain" \
    "${limit[@]}" \
    -p tcp --dport "$from_port" \
    -j REDIRECT --to-port "$to_port"

iptables -t nat -A OUTPUT -j "$chain"
iptables -t nat -A PREROUTING -j "$chain"
