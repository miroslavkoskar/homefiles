#!/usr/bin/env bash

set -eu

if (( EUID )); then
    sudo hostsblock "$@"
    exit
fi

cd /etc/hosts.d

prgname=${0##*/}

mute() { "$@" &>/dev/null || true; }
cleanup() { systemctl reload dnsmasq; }
trap cleanup EXIT

if (( ! $# )); then
    mute mv off/10-* .
    exit
fi
case $1 in
    antiad)
        mute mv 10-* off
        mute mv off/10-hostsblock .
        ;;
    off)
        mute mv 10-* off
        ;;
    reload)
        rm -f /etc/hostsblock/hosts{,.old.gz}
        rm -rf /var/cache/hostsblock
        /usr/bin/hostsblock
        ;;
    *)
        echo "usage: $prgname [antiad | off | reload]" >&2
        exit 2
        ;;
esac
