#!/usr/bin/env bash

set -eu -o pipefail

if (( EUID )); then
    echo 'This script must be run with root privileges.' >&2
    exit 1
fi

prgname=${0##*/}

if (( $# < 2 )); then
    echo "usage: $prgname table chain" >&2
    exit 2
fi

table=$1
chain=$2

iptables -t "$table" -F "$chain"
iptables -t "$table" -S | tac | awk -v chain="$chain" '
function escape(str) {
    gsub(/[\\.*?+|^$(){}\[\]]/, "\\\\&", str)
    return str
}
BEGIN {
    _chain = escape(chain)
}
$0 ~ "\\s+" _chain "(\\s*|$)" {
    if ($1 == "-A") printf "-D "
    else if ($1 == "-N") printf "-X "
    for (i=2; i<=NF; i++) printf $i " "
    printf "\n"
}
' | while read -ra args; do
    iptables -t "$table" "${args[@]}"
done
