#!/usr/bin/env bash

set -eu -o pipefail

if (( $EUID )); then
    echo 'This script must be run with root privileges.' >&2
    exit 1
fi

prgname=${0##*/}

if (( ! $# )); then
    echo "usage: $prgname name" >&2
    exit 2
fi

homedir=/home/nspawn/arch
mkdir -p "$homedir"
cd "$homedir"

# ----------------------------------------

(exec 8>.base.lck
flock 8
(exec 8<&-

if [[ ! -e base ]]; then
    mkdir base
    pkgs=(
        $(pacman -Sgq base base-devel | grep -Fxv linux)
    )
    pacstrap -c -d base "${pkgs[@]}"
fi

))

# ----------------------------------------

machine=$1
root=$machine

mkdir -p "$root" "${root}_"
unionfs -o allow_other,cow "${root}_"=RW:base=RO "$root"

cleanup() {
    mounted "$root" >/dev/null && umount "$root"
}
trap cleanup EXIT

exec systemd-nspawn --quiet --boot --link-journal=guest \
                    -M "$machine" --directory="$root"
