#!/usr/bin/env bash

set -eu -o pipefail
shopt -s extglob

prgname=${0##*/}

cleanup() {
    local retstat=$? tmp tmp_
    if (( retstat )); then
        tmp=$(squash <<<"$src" | asciionly)
        tmp_=${tmp:0:40}
        (( ${#tmp} > ${#tmp_} )) && tmp_+='â€¦'
        notify -u critical "$prgname $tmp_"
    fi
}
trap cleanup EXIT

[[ -t 1 ]] || exec >/dev/null
[[ -t 2 ]] || exec 2>/dev/null

src=${1:-$(xclip -o | head -c 255)}
case $src in
    http?(s)://www.rtvs.sk/* | \
    http?(s)://www.ustream.tv/* | \
    http?(s)://www.vaughnlive.tv/* \
        )
        printf -v title '%q' "$src"
        streamlink \
            --loglevel=error \
            --player-args="--title=$title --force-media-title=$title -- {filename}" \
            -- "$src"
        exit
        ;;
    http?(s)://*)
        mpv --player-operation-mode=pseudo-gui \
            --force-media-title="${2-}" -- "$src"
        ;;
    *)
        exit 2
        ;;
esac
