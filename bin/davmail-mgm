#!/bin/bash

set -e
umask 0077
exec > /dev/null

BASEDIR="$HOME/.davmail"
PIDFILE="$BASEDIR/davmail_mgm.pid"

function log() {
    echo "$*" >&2
}

if [ -f "$PIDFILE" ]; then
    PID="$(cat "$PIDFILE")"
    log "> terminating... $PID"
    pkill -P "$PID" 2>&1 || log "> not running... (nothing killed)"
    until ! ps -p "$PID"; do
        log "> sleeping..."
        sleep 1
    done
fi

log "> starting..."
nohup /usr/bin/davmail "$BASEDIR/davmail_mgm.properties" 2>&1 &
echo "$!" > "$PIDFILE"
