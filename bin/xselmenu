#!/usr/bin/env bash

set -eu -o pipefail

prgname=${0##*/}
prompt=${1:-$prgname}

tmpfile_psel=$(mktemp)
tmpfile_clip=$(mktemp)
cleanup() { rm -f "$tmpfile_psel" "$tmpfile_clip"; }
trap cleanup EXIT

sep=$'\x1F' # ASCII Unit Separator
id_psel="psel$sep"
id_clip="clip$sep"

out() {
    local id=$1 tmpfile=$2
    read -r lines bytes <<<"$(wc -cl <"$tmpfile")"
    if (( bytes > 0 )); then
        printf "%s%d/%d$sep%s$sep\n" \
            "$id" "$lines" "$bytes" "$(head -c 30 <"$tmpfile" | oneline)"
    fi
}

sel=$({
    xclip -o >"$tmpfile_psel"
    out "$id_psel" "$tmpfile_psel"
    xclip -o -selection clipboard >"$tmpfile_clip"
    out "$id_clip" "$tmpfile_clip"
} | dmenu1 "$prompt")

case $sel in
    "$id_psel"*)
        cat "$tmpfile_psel"
        ;;
    "$id_clip"*)
        cat "$tmpfile_clip"
        ;;
    *)
        printf '%s' "$sel"
        ;;
esac
