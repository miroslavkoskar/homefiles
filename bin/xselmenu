#!/usr/bin/env bash

set -eu -o pipefail

prgname=${0##*/}

tmpfile_psel=$(mktemp)
tmpfile_clip=$(mktemp)
cleanup() { rm -f "$tmpfile_psel" "$tmpfile_clip"; }
trap cleanup EXIT

out() {
    local id=$1 tmpfile=$2 lines bytes body
    read -r lines bytes < <(wc -cl <"$tmpfile")
    if (( bytes > 0 )); then
        body=$(head -c 50 <"$tmpfile" | oneline)
        printf "%s%d:%d$sep%s\n" "$id" "$lines" "$bytes" "$body"
    fi
}

sep='|'
id_psel="psel$sep"
id_clip="clip$sep"
prompt=${1:-$prgname}

read -r sel < <({
    xclip -o >"$tmpfile_psel"
    out "$id_psel" "$tmpfile_psel"
    xclip -o -selection clipboard >"$tmpfile_clip"
    out "$id_clip" "$tmpfile_clip"
} | dmenu1 "$prompt")

case $sel in
    "$id_psel"*)
        cat "$tmpfile_psel"
        ;;
    "$id_clip"*)
        cat "$tmpfile_clip"
        ;;
    *)
        printf '%s' "$sel"
        ;;
esac
