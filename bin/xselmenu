#!/bin/bash

set -e

prgname=$(basename "$0")
prompt=${1:-$prgname}

tmpfile_psel=$(mktemp)
tmpfile_clip=$(mktemp)
cleanup() { rm -f "$tmpfile_psel" "$tmpfile_clip"; }
trap cleanup EXIT

sep=$'\x1F' # ASCII Unit Separator
id_psel="psel$sep"
id_clip="clip$sep"

out() {
    local id=$1
    local tmpfile=$2
    read -r lines bytes <<<"$(wc -cl <"$tmpfile")"
    [ $bytes -gt 0 ] && \
        printf "$id$lines/$bytes$sep%s$sep\n" "$(head -c 30 <"$tmpfile" | oneline)"
}

sel=$({
    xclip -o >"$tmpfile_psel"
    out "$id_psel" "$tmpfile_psel"

    xclip -o -selection clipboard >"$tmpfile_clip"
    out "$id_clip" "$tmpfile_clip"
} | dmenu1 "$prompt")

case $sel in
    "$id_psel"*)
        cat "$tmpfile_psel"
        ;;
    "$id_clip"*)
        cat "$tmpfile_clip"
        ;;
    *)
        echo "$sel"
        ;;
esac
