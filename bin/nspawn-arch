#!/bin/bash

set -e

if [ $# -eq 0 ]; then
    echo "usage: $(basename "$0") name" >&2
    exit 2
fi

if [ $(id -u) -ne 0 ]; then
    sudo -- nspawn-arch "$@"
    exit
fi

basedir=$(dirname "$(realpath "$0")")
export PATH="$basedir:$PATH"

homedir=~miro/opt/nspawn/arch
mkdir -p "$homedir"
cd "$homedir"

# ----------------------------------------

(exec 8>"$XDG_RUNTIME_DIR/nspawn-arch.lock"
flock 8
(exec 8<&-

if [ ! -e base ]; then
    mkdir base
    pkgs=(
        $(pacman -Sgq base base-devel | grep -Fxv linux)
    )
    pacstrap -c -d base "${pkgs[@]}"
fi

))

# ----------------------------------------

machine=$1
root=$machine

mkdir -p "$root" "${root}_"
unionfs -o allow_other,cow "${root}_"=RW:base=RO "$root"

cleanup() {
    mounted "$root" >/dev/null && umount "$root"
}
trap cleanup EXIT

systemd-nspawn --quiet --boot --link-journal=guest -M "$machine" \
               --directory="$root"
