#!/usr/bin/env bash

set -eu

if [[ ! ${VIMSERVER-} && ${TMUX-} ]]; then
    IFS=, read -r -a var <<<"$TMUX"
    export VIMSERVER=$TMPDIR/nvim-tmux-${var[1]}-${var[2]}
fi
[[ ${VIMSERVER-} ]] || exit 1

(( $# )) || set -- .

case ${VIMBIN:-vim} in
    vim)
        exec vim --servername "$VIMSERVER" \
            --remote-tab-silent "$@"
        ;;
    nvim)
        if [[ -e $VIMSERVER ]]; then
            nvr --servername "$VIMSERVER" \
                --remote-tab "$@" \
                -c 'doau BufEnter' &>/dev/null && exit
        fi
        # shellcheck disable=SC2016
        exec nvim --cmd 'call serverstart($VIMSERVER)' "$@"
        ;;
    *)
        exit 2
        ;;
esac
