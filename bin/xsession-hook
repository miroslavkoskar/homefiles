#!/usr/bin/env bash

set -eu

screen=$(xserverq screen)
sfile=$XDG_RUNTIME_DIR/xorg/xsession:$screen
exec 8>"$sfile".lock
flock -n 8 && exit 3
session=$(<"$sfile")

sdu() { systemctl --user "$@"; }

case ${1-} in
    '')
        printf '%s\n' "$session"
        ;;

    pre)
        sdu start xsession@:"$screen".target
        set +e
        srun -rx picom
        srun -rx osdd
        srun -rx -n polkit-agent /usr/lib/mate-polkit/polkit-mate-authentication-agent-1
        srun -rxl -n sxhkd bash -c 'sleep 1; exec sxhkd'
        case $session in
            openbox | xfwm4)
                srun -rxl tint2
                ;;
            xmonad | main)
                srun -rx tray
                ;;
        esac
        ;;

    post)
        sdu stop xsession@:"$screen".target
        dispno=$(xserverq dispno)
        if [[ ! -e $sfile.keepserver ]] &&
            [[ ! -e $XDG_RUNTIME_DIR/xorg/keepserver:$dispno ]]; then
            spid=$(xserverq pid)
            sdu --quiet is-active xsession@:"$dispno".[0-9].target || kill "$spid"
        fi
        rm -rf "$sfile".keepserver
        ;;

    exec)
        case $session in
            i3)
                exec i3 -V
                ;;
            kodi)
                exec kodi -fs --debug
                ;;
            main)
                exec xmonad
                ;;
            openbox)
                exec openbox --startup 'xsession-hook startup'
                ;;
            rio)
                exec rio -term term -virtuals 4
                ;;
            xfwm4)
                exec xfwm4 --compositor=off
                ;;
            *)
                exec "${@:2}"
                ;;
        esac
        ;;

    startup)
        set +e
        case $session in
            main)
                srun -xl clementine
                srun -x workrave
                wait
                ;;
        esac
        ;;

    *)
        exit 2
        ;;
esac
