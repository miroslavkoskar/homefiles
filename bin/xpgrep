#!/bin/bash

set -e

_usage() {
    cat <<-EOF
	usage: $(basename "$0") [-f] pattern

	Match processes whose names (or command line if -f is specified) exactly
	match the pattern and have a matching DISPLAY environment variable set.
	EOF
}
usage() { _usage; exit 0; }
usage_err() { _usage >&2; exit 2; }

while getopts 'fh' opt; do
    case $opt in
        f)
            fopt='-f'
            ;;
        h)
            usage
            ;;
        *)
            usage_err
            ;;
    esac
done
shift $((OPTIND-1))

[ $# -eq 0 ] && usage_err

pgrep_opts=(-x $fopt)
pids=$(pgrep "${pgrep_opts[@]}" "$1")

for i in $pids; do
    env="/proc/$i/environ"
    [ -r "$env" ] && grep -Fzxq "DISPLAY=$DISPLAY" "$env" && echo "$i"
done

exit 0
