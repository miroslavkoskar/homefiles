#!/usr/bin/env bash

set -eu

prgname=${0##*/}

devname='nbd0'
dev="/dev/$devname"

if [[ $prgname  = 'img-umount' ]]; then
    umountall "$devname"
    qemu-nbd -d "$dev"
    exit
fi

if (( ! $# )); then
    echo "usage: $prgname image" >&2
    exit 2
fi

image=$1

modprobe nbd max_part=16
qemu-nbd -c "$dev" "$image"
lsblk "$dev"
