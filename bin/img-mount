#!/bin/bash

set -eu

devname='nbd0'
dev="/dev/$devname"

if [ "$(basename "$0")" = 'img-umount' ]; then
    umountall "$devname"
    qemu-nbd -d "$dev"
    exit
fi

if [ $# -eq 0 ]; then
    echo "usage: $(basename "$0") image" >&2
    exit 2
fi

image=$1

modprobe nbd max_part=16
qemu-nbd -c "$dev" "$image"
lsblk "$dev"
