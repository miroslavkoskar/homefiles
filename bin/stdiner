#!/bin/bash

set -e

_usage() {
    echo "usage: $(basename "$0") [-t | -T] [arg]..."
}
usage() { _usage; exit 0; }
usage_err() { _usage >&2; exit 2; }

while getopts 'tTh' opt; do
    case $opt in
        t)
            topt=1
            ;;
        T)
            Topt=1
            ;;
        h)
            usage
            ;;
        *)
            usage_err
            ;;
    esac
done
shift $((OPTIND-1))

if [ -t 0 ]; then
    echo 'stdin is a tty' >&2
    exit 1
fi

[ $# -eq 0 ] && set -- cat {}

if [ -n "$topt$Topt" ]; then
    file=$(mktemp -t 'stdiner.XXXXXXXXXX')
    cleanup() { rm -f "$file"; }
    trap cleanup EXIT
    cat >"$file"
else
    exec 8<&0
    file='/dev/fd/8'
fi
exec 0</dev/tty

args=("$@")
for i in "${!args[@]}"; do
    if [ "${args[$i]}" = '{}' ]; then
        args[$i]=$file
        farg=1
    fi
done

[ -z "$farg" ] && args+=("$file")

"${args[@]}"

if [ -n "$Topt" ]; then
    {
        trap cleanup EXIT
        sleep 30
        while fuser "$file"; do sleep 1; done
    } &
    trap - EXIT
fi
