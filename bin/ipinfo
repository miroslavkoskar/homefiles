#!/usr/bin/env bash

set -eu

prgname=${0##*/}

# http://checkip.amazonaws.com/
# http://ipinfo.io/
# https://api.ipify.org/
# https://ip.anysrc.net/banner
# https://ip.anysrc.net/json
# https://wtfismyip.com/json

if [[ $prgname = 'ipinfo-tor' ]]; then
    if (( ! $# )); then
        echo "usage: $prgname hostname" >&2
        exit 2
    fi
    resolve() { tor-resolve "$@" 2>/dev/null; }
fi

tmpfile=$(mktemp)
cleanup() { rm -f "$tmpfile"; }
trap cleanup EXIT

if (( $# )); then
    ip=$(resolve "$1")
    url="http://ipinfo.io/$ip"
else
    url='http://ipinfo.io/'
fi

stat=$(curl -sSL -w '%{http_code}\t%{url_effective}' -o "$tmpfile" "$url")
read -r scode surl <<<"$stat"
case $scode in
    200)
        jq . <"$tmpfile"
        ;;
    *)
        echo "HTTP $scode : $surl" >&2
        cat "$tmpfile" >&2
        exit 1
        ;;
esac
