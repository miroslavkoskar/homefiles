#!/bin/bash
#
# Session lock script with ``slock`` as backend.
#
# * disable SysRq
# * disable VT switching
# * run backend on display ':{current VT}'
#
# :Copyright: (c) 2013 Miroslav Koskar (http://mkoskar.com/)
# :License: BSD 2-Clause

set -eu

[ "${BASH_SOURCE:-}" ] && src=$(realpath -seq "$BASH_SOURCE") || exit 2

srcdir=$(dirname "$src")
export PATH="$srcdir:$PATH"

# target user
user='miro'

sysrq_path='/proc/sys/kernel/sysrq'
sysrq_old=$(<"$sysrq_path")
echo 0 >"$sysrq_path"

cleanup() {
    echo "$sysrq_old" >"$sysrq_path"
    vtswitch-lock -u
}
trap cleanup EXIT

vtswitch-lock

vtno=$(fgconsole)
su - "$user" -c "export DISPLAY=':$vtno'
                 export XAUTHORITY=~/.Xauthority
                 slock"
