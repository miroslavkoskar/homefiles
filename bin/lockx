#!/bin/bash
#
# Session lock script with `slock` as backend.
#
# * disable SysRq
# * disable VT switching
# * run backend on display ':{current VT}'
#
# :Copyright: (c) 2013 Miroslav Koskar (http://miroslavkoskar.com/)
# :License: BSD 2-Clause

set -e

basedir="$(dirname "$(realpath "$0")")"
export PATH="$basedir:$PATH"

# target user
user='miro'

sysrq_path='/proc/sys/kernel/sysrq'
sysrq_old="$(<"$sysrq_path")"
echo 0 >"$sysrq_path"

cleanup() {
    echo "$sysrq_old" >"$sysrq_path"
    vtswitch-lock -u
}
trap cleanup EXIT

vtswitch-lock

vtno="$(fgconsole)"
su - "$user" -c "export DISPLAY=':$vtno'
                 export XAUTHORITY=~/.Xauthority
                 slock"
