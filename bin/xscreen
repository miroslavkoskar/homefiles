#!/usr/bin/env bash

set -eu

export NOOSD=1

xrandr_layout() {
    local off=()
    while (( $# )); do
        if [[ $1 = -- ]]; then
            shift
            break
        fi
        off+=("$1")
        shift
    done
    local args=("$@")
    while (( $# )); do
        if [[ $1 = --output ]]; then
            shift
            (( $# )) || continue
            for i in "${!off[@]}"; do
                if [[ ${off[$i]} = "$1" ]]; then
                    unset off["$i"]
                    break
                fi
            done
        fi
        shift
    done
    for i in "${off[@]}"; do
        args+=(--output "$i" --off)
    done
    xrandr "${args[@]}"
}

post_hook() { apod set & }

# ----------------------------------------

src=~/bin/xscreen.$HOSTNAME
# shellcheck disable=SC1090
[[ -e $src ]] && . "$src"

xserver=$(xserverq name)
dispno=$(xserverq dispno)

set +e

xset b off s off r rate 500 35
xrdb -load ~/.Xresources

case $xserver in
    Xorg)
        xconfig=$(<"$XDG_RUNTIME_DIR/xorg/xconfig:$dispno")
        layout_hook_"$xconfig" "$@"
        xrandr --dpi 96
        xset dpms 0 0 300
        touchpad off
        trackpoint-wheel on
        (sleep 1; exec backlight-auto) &
        ;;
    Xephyr)
        xrdb -merge - <<<'Xft.dpi: 96'
        xrandr &>/dev/null # fixes screen after resize
        ;;
esac

xkb -
numlockx on
xsetroot -solid black -cursor_name left_ptr
hsetroot

post_hook
true
