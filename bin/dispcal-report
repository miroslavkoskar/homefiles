#!/usr/bin/env bash

set -eu -o pipefail

prgname=${0##*/}

echo $'\n--------------------------------------------------'
echo $'> _ICC_PROFILE atoms:'

readarray -t dall < <(dispcal -h |& LC_ALL=C grep -F Output | sed -r 's/^\s*//')
for (( i=0; i<${#dall[@]}; i++ )); do
    (( i > 0 )) && atom=_ICC_PROFILE_$i || atom=_ICC_PROFILE
    xprop -root -len 8 "$atom"
done

echo $'\n--------------------------------------------------'
echo '> Select display / monitor to continue:'

printf '%s\n' "${dall[@]}"
echo

read -N1 -rsp 'Your choice: ' dsel
echo

if [[ ! $dsel =~ ^[1-9]$ ]] || (( dsel > ${#dall[@]} )); then
    echo "$prgname: error: invalid choice" && exit 2
fi
printf '%s\n' "${dall[$((dsel-1))]}"

echo $'\n--------------------------------------------------'
echo '> Uncalibrated display:'
gopts=(-v2 -d$dsel -ye -P '0.5,0.5,2.0' -Yp)
dispcal "${gopts[@]}" -R

echo $'\n--------------------------------------------------'
echo '> Calibrated display:'
dispcal "${gopts[@]}" -r
echo
