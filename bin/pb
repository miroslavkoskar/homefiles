#!/usr/bin/env bash
#
# See also:
#
#   https://0x0.st/
#   https://paste.xinu.at/

set -eu

prgname=${0##*/}

tmpdir=$(mktemp -d)
cleanup() { rm -rf "$tmpdir"; }
trap cleanup EXIT

(( $# )) || set -- -

infile=$1
if [[ $infile = '-' ]]; then
    infile="$tmpdir/in"
    cat >"$infile"
fi
infile=$(realpath -- "$infile")
outfile="$tmpdir/out"

[[ -s $infile ]] || exit 1

case ${PB:-ptpb} in
    ix)
        # /<id>/<lexer>#n-<line>
        curl -sSL -F "f:1=@$infile" -o "$outfile" http://ix.io/
        cat "$outfile"
        ;;
    ptpb)
        # /<id>/<lexer>/<formatter>#L-<line>
        curl -sS -F "c=@$infile" -w '%{redirect_url}\n' -o "$outfile" \
            https://ptpb.pw/?r=1
        ;;
    sprunge)
        # /<id>?<lexer>#n-<line>
        curl -sSL -F "sprunge=@$infile" -o "$outfile" http://sprunge.us/
        cat "$outfile"
        ;;
    *)
        exit 2
        ;;
esac

histfile="$HOME/.local/share/pb_history"
ts=$(date +%F.%s)

cat >>"$histfile" <<-EOF

	$ts $prgname [$*]
	--------------------------------------------------
EOF
cat "$outfile" >>"$histfile"
