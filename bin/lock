#!/bin/bash
#
# Session lock script with `away` as backend.
#
# * disable SysRq
# * switch to VT 8
# * disable VT switching
# * run backend
#
# :Copyright: (c) 2013 Miroslav Koskar (http://miroslavkoskar.com/)
# :License: BSD 2-clause

set -e

export TERM='linux'

# because of where `vtswitch-lock` is installed
export PATH="/home/miro/bin:$PATH"

# target user
user='miro'

vtno_old="$(fgconsole)"
vtno_new=8
vtnew="/dev/tty$vtno_new"

exec <>"$vtnew" >&0 2>&1

sysrq_path='/proc/sys/kernel/sysrq'
sysrq_old="$(<"$sysrq_path")"
echo 0 >"$sysrq_path"

cleanup() {
    clear
    echo "$sysrq_old" >"$sysrq_path"
    vtswitch-lock -u
    chvt "$vtno_old"
}
trap cleanup EXIT

clear
tput civis

chvt "$vtno_new"
vtswitch-lock
chown "$user" "$vtnew"

su - "$user" -c 'away -C away'
read
