#!/bin/bash
#
# Session lock script with `away` as backend.
#
# * disable SysRq
# * switch to VT 8
# * disable VT switching
# * run backend
#
# :Copyright: Copyright 2013 by Miroslav Koskar
# :License: BSD

set -e

export TERM='linux'

# because of where `vtswitch-lock` is installed
export PATH="/home/miro/bin:$PATH"

# target user
user='miro'

vtold="$(fgconsole)"
vtnew=8
exec <>"/dev/tty$vtnew" >&0 2>&1

sysrq_path='/proc/sys/kernel/sysrq'
sysrq_old="$(<"$sysrq_path")"
echo 0 >"$sysrq_path"

cleanup() {
    clear
    echo "$sysrq_old" >"$sysrq_path"
    vtswitch-lock -u
    chvt "$vtold"
}
trap cleanup EXIT

clear
tput civis

chvt "$vtnew"
vtswitch-lock

su - "$user" -c 'away -C away'
read
