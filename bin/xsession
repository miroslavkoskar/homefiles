#!/usr/bin/env bash

set -eu

prgname=${0##*/}

[[ ${XSESSION-} ]] && exit 1

printf '%s: %s\n' "$prgname" "$*" >&2

cleanup() {
    local retstat=$?
    printf '%s: exit %s\n' "$prgname" "$retstat" >&2
    kill 0
}
trap cleanup EXIT

for f in /etc/X11/xinit/xinitrc.d/*; do
    [[ -f $f ]] || continue
    [[ $f = '/etc/X11/xinit/xinitrc.d/50-systemd-user.sh' ]] && continue
    . "$f"
done

xserver=$(xserverq name)

xrdb -load ~/.Xresources

if [[ $xserver = 'Xephyr' ]]; then
    xrdb -merge - <<<'Xft.dpi: 96'
fi

xscreen -

srun -xr /usr/lib/mate-polkit/polkit-mate-authentication-agent-1

if [[ $xserver = 'Xorg' ]]; then
    srun -xr compton
fi

_main() {
    srun -xr osdd
    _xmonad
}

_openbox() {
    srun -xr tint2
    openbox
}

_xmonad() {
    srun -xr tray
    xmonad
}

session=$1
export XSESSION=$session
case $session in
    main | openbox | xmonad)
        "_$session"
        ;;
    *)
        (( $# )) && command "$@"
        ;;
esac
