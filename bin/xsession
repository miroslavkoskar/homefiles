#!/bin/bash

set -e

cleanup() { kill $(jobs -p); }
trap cleanup EXIT

# startx unsets DBUS_SESSION_BUS_ADDRESS, let's set it back
export DBUS_SESSION_BUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"

if [ -d /etc/X11/xinit/xinitrc.d ]; then
    for i in /etc/X11/xinit/xinitrc.d/* ; do
        [ -f "$i" ] && . "$i"
    done
fi

xresources="$HOME/.Xresources"
if [ -e "$xresources" ]; then
    xrdb -load "$xresources"
fi

xmodmap="$HOME/.Xmodmap"
if [ -e "$xmodmap" ]; then
    xmodmap "$xmodmap"
fi

xkb
xscreen
audio pulse_init

if [ "$(xserverq name)" = 'Xorg' ]; then
    #compton
    :
fi

_main() {
    xrun osdd &
    xrun dunst &
    #xrun keynav &
    _xmonad
}

_herbstluftwm() {
    herbstluftwm --locked
}

_openbox() {
    xrun tint2 &
    openbox
}

_xmonad() {
    xrun tray &
    xmonad
}

session=$1
case $session in
    main | herbstluftwm | openbox | xmonad)
        export XSESSION=$session
        _$session
        ;;
    *)
        [ $# -eq 0 ] || command "$@"
        ;;
esac
