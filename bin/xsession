#!/usr/bin/env bash

set -eu

prgname=${0##*/}

sessions=(
    jwm
    main
    openbox
    rio
    xfwm4
    xmonad
)

(( $# )) || set -- main

if [[ $1 = '-?' ]]; then
    printf '%s\n' "${sessions[@]}"
    exit
fi

[[ ${XSESSION-} ]] && exit 1
unset SESSION_MANAGER

for i in "${sessions[@]}"; do
    if [[ $1 = "$i" ]]; then
        export XSESSION=$i
        break
    fi
done

printf '%s: %s\n' "$prgname" "$*" >&2

main() {
    xmonad "$@"
}

openbox() {
    srun -xr tint2
    command openbox --startup 'xsession-hook startup'
}

rio() {
    command rio -term term -virtuals 4
}

xfwm4() {
    srun -xr tint2
    command xfwm4 --compositor=off
}

xmonad() {
    srun -xr tray
    command xmonad
}

cleanup() {
    local retstat=$?
    printf '%s: exit %s\n' "$prgname" "$retstat" >&2
    # shellcheck disable=SC2046
    kill $(jobs -p) &>/dev/null || true
}
trap cleanup EXIT

for f in /etc/X11/xinit/xinitrc.d/*; do
    [[ -f $f ]] || continue
    [[ $f = '/etc/X11/xinit/xinitrc.d/50-systemd-user.sh' ]] && continue
    . "$f"
done

xserver=$(xserverq name)

xrdb -load ~/.Xresources

if [[ $xserver = 'Xephyr' ]]; then
    xrdb -merge - <<<'Xft.dpi: 96'
fi

xscreen -

srun -xr compton
srun -xr osdd

(sleep 1; exec sxhkd) &
/usr/lib/mate-polkit/polkit-mate-authentication-agent-1 &

if [[ ${XSESSION-} ]]; then
    "$@"
else
    export XSESSION='unknown'
    command "$@"
fi
