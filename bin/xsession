#!/usr/bin/env bash

set -eu

cleanup() {
    local pids
    pids=($(jobs -p))
    (( ${#pids[@]} )) && kill "${pids[@]}"
}
trap cleanup EXIT

if [[ -d /etc/X11/xinit/xinitrc.d ]]; then
    for i in /etc/X11/xinit/xinitrc.d/* ; do
        [[ -f $i ]] && . "$i"
    done
fi

xresources="$HOME/.Xresources"
if [[ -e $xresources ]]; then
    xrdb -load "$xresources"
fi

xmodmap="$HOME/.Xmodmap"
if [[ -e $xmodmap ]]; then
    xmodmap "$xmodmap"
fi

xscreen
/usr/lib/mate-polkit/polkit-mate-authentication-agent-1 &

if [[ $(xserverq name) = 'Xorg' ]]; then
    xrun compton &
fi

_main() {
    xrun osdd &
    xrun dunst &
    #xrun keynav &
    _xmonad
}

_herbstluftwm() {
    herbstluftwm --locked
}

_openbox() {
    xrun tint2 &
    openbox
}

_xmonad() {
    xrun tray &
    xmonad
}

session=$1
case $session in
    main | herbstluftwm | openbox | xmonad)
        export XSESSION=$session
        _$session
        ;;
    *)
        (( $# )) && command "$@"
        ;;
esac
