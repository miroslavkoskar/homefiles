#!/usr/bin/env bash

set -eu -o pipefail

prgname=${0##*/}

lockfile="$XDG_RUNTIME_DIR/scast$DISPLAY.lock"

if [[ $prgname = 'scast-off' ]]; then
    lsof -t -a -c ffmpeg "$lockfile" | xargs -r kill
    exit
fi

cd ~/tmp

ts=$(date +%F.%s)
outfile="screencast-$ts.mkv"

(exec 8>"$lockfile"
if ! flock -n 8; then
    notify "___ $prgname ON ___"
    exit 3
fi

read -r X Y W H < <(slop -f $'%x %y %w %h\n')

# See also:
#
#   x264 --fullhelp
#   ffmpeg -h encoder=libx264

ffmpeg -loglevel quiet \
    -f x11grab -framerate 30 -show_region 1 -s "${W}x${H}" -i "$DISPLAY+$X,$Y" \
    -vcodec libx264 -qp 0 -preset ultrafast "$outfile" || true
)

[[ -e $outfile ]] && mpv --loop-file=inf "$outfile"
