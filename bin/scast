#!/usr/bin/env bash

set -eu -o pipefail

prgname=${0##*/}

cd ~/tmp

ts=$(date +%F.%s)
outfile="screencast-$ts.mkv"

lockfile="$XDG_RUNTIME_DIR/$prgname$DISPLAY.lock"
exec 8>"$lockfile"
flock -n 8 || {
    exec 8<&-
    lsof -t "$lockfile" | xargs -r kill
    exit
}

tmp=$(slop -f '%x %y %w %h')
read -r X Y W H <<<"$tmp"

(
    exec &>>~/.local/share/"$prgname".out

    # See also:
    #
    #   x264 --fullhelp
    #   ffmpeg -h encoder=libx264

    ffmpeg -loglevel quiet \
        -f x11grab -framerate 30 -show_region 1 -s "${W}x${H}" -i "$DISPLAY+$X,$Y" \
        -vcodec libx264 -qp 0 -preset ultrafast "$outfile" &

    exec 8<&-
    wait

    mpv --loop-file=inf "$outfile"
) &
