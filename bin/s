#!/bin/bash

set -e

prgname=$(basename "$0")

# ----------------------------------------

cmd() {
    tmux -L "${socket:-default}" "$@"
}

exists () {
    cmd has -t "$session" >/dev/null 2>&1
}

new() {
    local name=$(cmd new -dP)
    if [ ! "$name" = "$session:" ]; then
        cmd rename -t "$name" "$session"
    fi
    cmd setenv -t "$session" BASEDIR "$PWD" \
        \; neww -kt :0 "$@"
}

neww() {
    cmd neww -t "$session:" "$@"
}

# ----------------------------------------

_s() {
    new
    neww -d
}

_sp() {
    new 'trun ranger' \
        \; setw remain-on-exit on \
        \; setw main-pane-height 30 \
        \; selectl main-horizontal

    neww 'trun vim --servername "$TMUX"' \
        \; setw remain-on-exit on \
        \; splitw -h \
        \; setw main-pane-width 84 \
        \; selectl main-vertical
}

# ----------------------------------------

_adm() {
    cd ~
    _sp
    neww -d
}

_aux() {
    cd ~

    local notesdir=~/projects/notes/src
    new -n notes -c "$notesdir" 'trun e' \
        \; setw remain-on-exit on \
        \; splitw -h -c "$notesdir" \
        \; setw main-pane-width 121 \
        \; selectl main-vertical \
        \; selectp -t :.0

    neww -n mail 'trun mutt' \
        \; setw remain-on-exit on

    neww -n chat 'trun weechat' \
        \; setw remain-on-exit on

    neww -n feeds 'trun newsbeuter' \
        \; setw remain-on-exit on \
        \; splitw -h 'trun respawn podbeuter' \
        \; selectl even-horizontal \
        \; selectp -t :.0

    cmd selectw -t :1
}

_mon() {
    cd ~

    new -n top 'trun onsigwinch-exec tmux selectl -- conky' \
        \; setw remain-on-exit on \
        \; splitw -h 'trun htop' \
        \; setw main-pane-width 43 \
        \; selectl main-vertical

    neww -n journal 'trun journalctl --system -f' \
        \; setw remain-on-exit on \
        \; splitw -v 'trun journalctl --user -f' \
        \; selectl even-vertical \
        \; selectp -t :.0

    neww -n sstat 'trun pgx ss' \
        \; setw remain-on-exit on

    neww 'trun iftop' \
        \; setw remain-on-exit on

    neww -n logs -c /var/log

    cmd selectw -t :0
}

_tmp() {
    cd ~/tmp
    _s
}

_wrk() {
    cd ~/projects
    _sp
}

# ----------------------------------------

attach=1
if [ $# -gt 0 -a -z "${1##-*}" ]; then
    [ ! "$1" = '-d' ] && exit 2
    unset attach
    shift
fi

session=$1
if [ -z "$session" ]; then
    session=$(sed -r "s,^$HOME(/|$),~\1," <<<"$PWD")
    if [ ! "$session" = '/' -a ! "$session" = '~' ]; then
        sdigest=$(sha1sum | awk '{print $1}' <<<"$session")
        session=$(tr '.:' _ <<<"$session")
        session="=${session##*/}_#${sdigest: -2}"
    fi
fi

socket=$2

(exec 8<"$(realpath "$0")"
if ! flock -w 30 8; then
    exit 3
fi
(exec 8<&-

if ! exists; then
    case $session in
        adm | aux | mon | tmp | wrk)
            _$session
            ;;
        *)
            case $prgname in s | sp) ;; *) exit 2 ;; esac
            _$prgname
            ;;
    esac
fi

))

if [ -n "$attach" ]; then
    cmd attach -t "$session"
fi
