#!/usr/bin/env bash

set -eu -o pipefail

prgname=${0##*/}

# ----------------------------------------

cmd() {
    tmux -L "$socket" "$@"
}

exists () {
    cmd has -t "=$session" &>/dev/null
}

new() {
    cmd new -d -s "$session" true \; setw remain-on-exit on
    cmd setenv -t "=$session" SHOME "$PWD" \; neww -kt :0 "$@"
}

neww() {
    cmd neww -t "=$session" "$@"
}

# ----------------------------------------

_s() {
    new
    neww -d
}

_sp() {
    new 'trun ranger' \
        \; setw remain-on-exit on \
        \; setw main-pane-height 30 \
        \; selectl main-horizontal

    neww 'trun ee' \
        \; setw remain-on-exit on \
        \; splitw -h \
        \; setw main-pane-width 84 \
        \; selectl main-vertical
}

# ----------------------------------------

_adm() {
    cd ~
    _sp
    neww -d
}

_aux() {
    cd ~

    local notesdir="$HOME/projects/notes/src"
    new -n notes -c "$notesdir" 'trun e' \
        \; setw remain-on-exit on \
        \; splitw -h -c "$notesdir" \
        \; setw main-pane-width 121 \
        \; selectl main-vertical \
        \; selectp -t :.0
        #\; resize-pane -Z

    neww -n mail 'trun mutt' \
        \; setw remain-on-exit on

    neww -n chat 'trun weechat' \
        \; setw remain-on-exit on

    neww -n feeds 'trun newsbeuter -q' \
        \; setw remain-on-exit on

    #neww -n music 'trun ncmpcpp' \
    #    \; setw remain-on-exit on

    cmd selectw -t :1
}

_mon() {
    cd ~

    new -n top 'onsighup-terminate conky -q' \
        \; setw remain-on-exit on \
        \; splitw -h 'trun htop' \
        \; setw main-pane-width 43 \
        \; selectl main-vertical

    neww -n journal 'trun journalctl --system -f' \
        \; setw remain-on-exit on \
        \; splitw -v 'trun journalctl --user -f' \
        \; selectl even-vertical \
        \; selectp -t :.0

    neww -n sstat 'trun pgx sstat' \
        \; setw remain-on-exit on

    neww -n iftop 'trun iftop -i eth0' \
        \; setw remain-on-exit on \
        \; splitw -v 'trun iftop -i wlan0'

    neww -n logs -c /var/log

    cmd selectw -t :0
}

_tmp() {
    cd ~/tmp
    _s
}

_wrk() {
    cd ~/projects
    _sp
}

# ----------------------------------------

_usage() {
    echo "usage: $prgname [-d] [-s socket] [session]"
}
usage() { _usage; exit 0; }
usage_err() { _usage; exit 2; } >&2

socket='default'
declare -i attach=1
while getopts 'ds:h' opt; do
    case $opt in
        d)
            attach=0
            ;;
        s)
            socket=$OPTARG
            ;;
        h)
            usage
            ;;
        *)
            usage_err
            ;;
    esac
done
shift $((OPTIND-1))

if [[ ${TMUX-} ]]; then
    IFS=, read -ra var <<<"$TMUX"
    if [[ $socket = "${var[0]##*/}" ]]; then
        echo "$prgname: cannot operate from within session of the same target socket" >&2
        exit 1
    fi
fi

session=${1-}

if [[ ! $session ]]; then
    session="$PWD/"
    session=${session/#"$HOME/"/\~/}
    session=${session%/}
fi

(exec 8>"$XDG_RUNTIME_DIR/s.lock"
flock -w 30 8 || exit 3
(exec 8<&-

if ! exists; then
    case $session in
        adm | aux | mon | tmp | wrk)
            "_$session"
            ;;
        *)
            case $prgname in s | sp) ;; *) exit 2 ;; esac
            "_$prgname"
            ;;
    esac
fi

))

if (( attach )); then
    exec tmux -L "$socket" attach -t "=$session"
fi
