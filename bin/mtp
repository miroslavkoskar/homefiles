#!/usr/bin/env bash
#
# Simple 'jmtpfs' frontend.

set -euf -o pipefail

readarray -t mounts < <(grep -P '^jmtpfs ' /proc/mounts | sort -u)
if (( ${#mounts[@]} > 0 )); then
    echo -e "\nMounts:\n${mounts[*]}"
    echo
    if confirm 'Unmount?' y; then
        PS3='Select: '
        select sel in "${mounts[@]}"; do
            break
        done
        [[ $sel ]] || exit 2

        sel=($sel)
        target=${sel[1]}

        fusermount -u "$target"
        rm -d "$target"
    fi
fi

readarray -t devices < <(jmtpfs -l 2>/dev/null | grep -P '^\d, .*' | sort -u)
if (( ${#devices[@]} > 0 )); then
    echo
    if confirm 'Mount?' y; then
        PS3='Select: '
        select sel in "${devices[@]}"; do
            break
        done
        [[ $sel ]] || exit 2

        device=($(awk -F ', ' '{print $1 " " $2}' <<<"$sel"))
        target="$HOME/tmp/mtp-${device[0]}-${device[1]}"

        if ! findmnt -M "$target" &>/dev/null; then
            [[ -d $target ]] || mkdir "$target"
            jmtpfs "-device=${device[0]},${device[1]}" "$target" &>/dev/null
        fi
    fi
fi
echo
