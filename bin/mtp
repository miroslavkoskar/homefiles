#!/usr/bin/env bash
#
# Simple 'jmtpfs' frontend.

set -eu -o pipefail

mounts=$(grep '^jmtpfs ' /proc/mounts | sort -u) || true
if [[ $mounts ]]; then
    readarray -t mounts <<<"$mounts"
    printf '\nMounts:\n%s\n' "${mounts[*]}"
    echo
    if confirm 'Unmount?' y; then
        PS3='Select: '
        select sel in "${mounts[@]}"; do
            break
        done
        [[ $sel ]] || exit 2

        read -r sel target _ <<<"$sel"
        fusermount -u "$target"
        rm -d "$target"
    fi
fi

devices=$(jmtpfs -l 2>/dev/null | grep -P '^\d, .*' | sort -u)
if [[ $devices ]]; then
    readarray -t devices <<<"$devices"
    echo
    if confirm 'Mount?' y; then
        PS3='Select: '
        select sel in "${devices[@]}"; do
            break
        done
        [[ $sel ]] || exit 2

        device=$(awk -F ', ' '{ print $1 " " $2 }' <<<"$sel")
        read -r -a device <<<"$device"
        target=~/tmp/mtp-${device[0]}-${device[1]}

        if ! findmnt -M "$target" &>/dev/null; then
            [[ -d $target ]] || mkdir "$target"
            jmtpfs -device="${device[0]},${device[1]}" "$target" &>/dev/null
        fi
    fi
fi
echo
