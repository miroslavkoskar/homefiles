#!/usr/bin/env bash
#
# This is rather abusive in calling 'ps' per each process in process tree.

set -eu -o pipefail

prgname=${0##*/}
pid=${1:-$$}

[ "$pid" -gt 0 ] 2>/dev/null || {
    echo "usage: $prgname pid" >&2
    exit 2
}

oformat='pgid='

recurse() {
    local ppid=$1
    [[ $ppid = "$$" ]] && return
    { ps --ppid "$ppid" -o pid= -o "$oformat" || true; } | while read -r _pid out; do
        echo "$out"
        recurse "$_pid"
    done
}

ps --pid "$pid" -o "$oformat" | sed 's/^\s*//'
recurse "$pid"
