#!/bin/bash

set -e

case $1 in -h|--help)
    cat <<-EOF
	usage: ff | firefox [arg]...
	       ffp [profile] [arg]...
	       ffa | firefox-aurora [profile] [arg]...
	EOF
    exit
    ;;
esac

prgname=$(basename "$0")

# ----------------------------------------

bin='/usr/bin/firefox'

case $prgname in
    ff | firefox)
        profile='default'
        ;;
    ffa | firefox-aurora)
        bin='/usr/bin/firefox-aurora'
        regexp='^aurora'
        ;;
    *)
        regexp='^(?!default$)(?!dev-edition-default$)(?!aurora).*$'
        ;;
esac

# ----------------------------------------

if [ -z "$profile" ]; then
    profiles=($(awk -F = '/Name/ {print $2}' <~/.mozilla/firefox/profiles.ini | grep -P "$regexp" | sort))

    if [ $# -gt 0 ]; then
        for p in "${profiles[@]}"; do
            if [ "$p" = "$1" ]; then
                profile=$1
                shift
                break
            fi
        done
    fi

    if [ -z "$profile" ]; then
        profile=$(IFS=$'\n'; echo "${profiles[*]}" | dmenu1 "$prgname")
    fi

    [ -z "$profile" ] && exit 1
fi

export LOGNAME="$USER.$profile"
exec "$bin" --class "Firefox ($profile)" -P "$profile" "$@"
