#!/usr/bin/env bash

set -eu

prgname=${0##*/}

case ${1-} in -h | --help)
    cat <<-EOF
	usage: ff | firefox [arg]...
	       ffa | firefox-aurora [profile [arg]...]
	       ffp [profile [arg]...]
	EOF
    exit
    ;;
esac

profile=
bin='/usr/bin/firefox'

case $prgname in
    ff | firefox)
        profile='default'
        ;;
    ffa | firefox-aurora)
        bin='/usr/bin/firefox-aurora'
        regexp='^aurora'
        ;;
    *)
        regexp='^(?!default$)(?!dev-edition-default$)(?!aurora).*$'
        ;;
esac

if [[ ! $profile ]] && (( $# )); then
    profile=$1
    shift
fi

if [[ ! $profile ]]; then
    profiles=(
        devel
        lab
        plain
        proxy
        quarantine
    )
    profiles+=($(awk -F= '/Name/ {print $2}' <~/.mozilla/firefox/profiles.ini))
    profile=$(
        IFS=$'\n'; echo "${profiles[*]}" |
        sort -u | grep -P "$regexp" |
        dmenu1 "$prgname"
    )
fi

[[ ! $profile ]] && exit 1

# Workaround to ensure separate instance per profile.
#export LOGNAME="$USER.$profile"

exec "$bin" --class "Firefox ($profile)" -P "$profile" "$@"
