#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
    colors-gtk
    ~~~~~~~~~~

    Set terminal ANSI colors (palette 0-15, foreground, background, cursor).

    :Compatibility: Python 2.6 / 3.0
    :Copyright: Copyright 2013 by Miroslav Koskar
    :License: BSD
"""

import signal

from colors import set_color, set_colorfg, set_colorbg, set_colorcur
from gi.repository import Gdk
from gi.repository import Gtk

signal.signal(signal.SIGINT, signal.SIG_DFL)


def color_to_hex(color):
    rgb = (color.red, color.green, color.blue)
    rgb = tuple(map(lambda x: int(x * 255), rgb))
    return '#{:02X}{:02X}{:02X}'.format(*rgb)


class MainWindow(Gtk.Window):

    def __init__(self):
        Gtk.Window.__init__(self, title='Set Terminal ANSI Colors', resizable=False)

        grid = Gtk.Grid()

        self.cbuttons = []
        for n in range(16):
            btn = Gtk.ColorButton()
            btn.set_size_request(80, 80)
            btn.connect('color-set', self.on_color_set, n)
            self.cbuttons.append(btn)
            lbl = Gtk.Label()
            lbl.set_text('color{}'.format(n))
            grid.attach(btn, n % 8, 2 * (n // 8), 1, 1)
            grid.attach(lbl, n % 8, 1 + 2 * (n // 8), 1, 1)

        btn = Gtk.ColorButton()
        btn.set_size_request(0, 50)
        btn.connect('color-set', self.on_colorfg_set)
        self.fgbutton = btn
        lbl = Gtk.Label()
        lbl.set_text('FG')
        grid.attach(btn, 0, 5, 3, 1)
        grid.attach(lbl, 0, 6, 3, 1)

        btn = Gtk.ColorButton()
        btn.set_size_request(0, 50)
        btn.connect('color-set', self.on_colorbg_set)
        self.bgbutton = btn
        lbl = Gtk.Label()
        lbl.set_text('BG')
        grid.attach(btn, 3, 5, 3, 1)
        grid.attach(lbl, 3, 6, 3, 1)

        btn = Gtk.ColorButton()
        btn.set_size_request(0, 50)
        btn.connect('color-set', self.on_colorcur_set)
        self.curbutton = btn
        lbl = Gtk.Label()
        lbl.set_text('CUR')
        grid.attach(btn, 6, 5, 2, 1)
        grid.attach(lbl, 6, 6, 2, 1)

        self.add(grid)

    def on_color_set(self, widget, n):
        color = widget.get_rgba()
        set_color(n, color_to_hex(color), flush=True)

    def on_colorfg_set(self, widget):
        color = widget.get_rgba()
        set_colorfg(color_to_hex(color), flush=True)

    def on_colorbg_set(self, widget):
        color = widget.get_rgba()
        set_colorbg(color_to_hex(color), flush=True)

    def on_colorcur_set(self, widget):
        color = widget.get_rgba()
        set_colorcur(color_to_hex(color), flush=True)


win = MainWindow()
win.connect('delete-event', Gtk.main_quit)
win.show_all()
Gtk.main()
