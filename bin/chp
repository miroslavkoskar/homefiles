#!/usr/bin/env bash

set -eu
shopt -s nullglob

prgname=${0##*/}

_usage() {
    echo "usage: $prgname [profile [arg]...]"
}
usage() { _usage; exit 0; }
usage_err() { _usage; exit 2; } >&2

while getopts 'h' opt; do
    case $opt in
        h)
            usage
            ;;
        *)
            usage_err
            ;;
    esac
done
shift $((OPTIND-1))

# ----------------------------------------

profile=
regexp='^(?!proxy-socks$)(?!proxy-tor$).*$'

if (( $# )); then
    profile=$1
    shift
fi

if [[ ! $profile ]]; then
    profiles=(
        devel
        lab
        plain
        proxy
    )
    for p in ~/.config/google-chrome.*; do
        profiles+=("${p#*google-chrome.}")
    done
    profile=$(
        (set +u; IFS=$'\n'; printf '%s' "${profiles[*]}") |
        sort -u | grep -P "$regexp" |
        dmenu1 "$prgname"
    )
fi

[[ ! $profile ]] && exit 1

path="$HOME/.config/google-chrome"
[[ $profile = 'default' ]] || path+=".$profile"

exec ch0 --user-data-dir="$path" "$@"
