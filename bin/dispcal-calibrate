#!/usr/bin/env bash

set -eu -o pipefail

prgname=${0##*/}

echo $'\n--------------------------------------------------'
echo $'> Select display to continue:\n'

dall=$({ dispwin -? || true; } |& sed -nr "s/^\s*([0-9]+ = 'Screen [0-9]+, Output .*)/\1/p")
readarray -t dall <<<"$dall"
(( ${#dall[@]} )) || exit 1

printf '%s\n' "${dall[@]}"
echo

read -N1 -rsp 'Your choice: ' dsel
echo

if [[ ! $dsel =~ ^[1-9]$ ]] || (( dsel > ${#dall[@]} )); then
    echo "$prgname: error: invalid choice" && exit 2
fi

ts=$(date +%F.%s)
odir="$HOME/.local/share/icc/d$dsel.$ts"

mkdir -p "$odir"
cd "$odir"

printf '%s\n' "${dall[$((dsel-1))]}" | tee display

# ----------------------------------------

# Brightness:
#
#   80-120 cd/m2 - increasing with the brightness of the working environment
#
# White Point:
#
#   5000K/5500K - commonly used in CMYK reproduction
#   6500K - commonly used for general purpose and images on the web

# ArgyllCMS doesn't handle SIGINT properly
trap 'trap - INT; kill -INT -$$' INT

echo $'\n--------------------------------------------------'
echo $'> Calibrating & Profiling:\n'

gopts=(-v -d$dsel -ye -P '0.5,0.5,2.0')

dispcal "${gopts[@]}" -qm -t6500 -g2.2 -k0 out
[[ -e out.cal ]] || exit 1

cp /usr/share/DisplayCAL/ti1/d3-e4-s5-g49-m5-b0-f0.ti1 out.ti1
dispread "${gopts[@]}" -Yp -N -k out.cal out
colprof -v -Zp out
echo
